pr:
  - develop
  - main

pool:
  vmImage: "ubuntu-latest"

variables:
- name: DOCKER_IMAGE_NAME
  value: rag_core_lib:$(Build.SourceBranchName)-$(Build.BuildId)

stages:
- stage: BuildAndTest
  jobs:
  - job: Build
    steps:
    - script: |
        docker build -t $DOCKER_IMAGE_NAME -f Dockerfile .
      displayName: "Building docker image."
    # Note that the pyproject.toml is already copied into the docker image. Also note that copy
    # pasting the whole /app folder will overwrite the existing .venv folder in the docker image
    - script: |
        docker run --rm $DOCKER_IMAGE_NAME make lint
      displayName: "Generating lint report."
    - script: |
        docker run --rm -v $(pwd)/htmlcov:/app/htmlcov $DOCKER_IMAGE_NAME make test
      displayName: "Running unit tests with test"
